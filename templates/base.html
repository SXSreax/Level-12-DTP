<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Marvel Rival Website{% endblock %}</title>
    <link
      href="https://fonts.googleapis.com/css?family=Oswald:700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:400,600&display=swap"
      rel="stylesheet"
    />
    <!-- Linking CSS file for base layout -->
    <link
      href="{{ url_for('static', filename='css/base.css') }}"
      rel="stylesheet"
    />
    {% block head %}{% endblock %}
  </head>
  <body>
    <nav class="main-nav-bar">
      <div class="nav-outer-flex">
        <div class="nav-side"></div>
        <div class="nav-links">
          <a href="{{ url_for('home.home') }}">Home</a>
          <a href="{{ url_for('heroes.heroes') }}">All Heroes</a>
          <a href="{{ url_for('favorite.favorite') }}">Favorites</a>
          <a href="{{ url_for('compare.compare_select') }}">Compare</a>
        </div>
        <div class="nav-profile-container">
          <div class="profile-dropdown-wrapper" id="profileDropdownWrapper">
            <img
              src="{{ url_for('static', filename=profile_image_url) }}"
              alt="Profile"
              class="nav-profile-img"
              tabindex="0"
              onclick="toggleProfileDropdown()"
            />
            <div id="profileDropdown" class="profile-dropdown">
              <a href="{{ url_for('user.user_page') }}">User Page</a>
              <a href="{{ url_for('login.login') }}">Login</a>
              <a href="{{ url_for('signup.signup') }}">Sign Up</a>
              <a href="{{ url_for('login.logout') }}">Logout</a>
            </div>
          </div>
        </div>
      </div>
    </nav>
    {% block content %}{% endblock %}

    <!-- AI Chat Widget -->
    <div id="ai-chat-widget">
      <div id="ai-chat-minimized" onclick="expandChat()">
        <span>ðŸ’¬</span>
      </div>
      <div id="ai-chat-expanded" style="display: none">
        <div id="ai-chat-header">
          <span>AI Chat</span>
          <button onclick="minimizeChat()">_</button>
          <button onclick="closeChat()">Ã—</button>
        </div>
        <div id="ai-chat-messages"></div>
        <form id="ai-chat-form" onsubmit="sendMessage(event)">
          <input
            type="text"
            id="ai-chat-input"
            placeholder="Ask me anything..."
            autocomplete="off"
            required
          />
          <button type="submit">Send</button>
        </form>
      </div>
    </div>
    <script>
      function expandChat() {
        document.getElementById("ai-chat-minimized").style.display = "none";
        document.getElementById("ai-chat-expanded").style.display = "flex";
      }
      function minimizeChat() {
        document.getElementById("ai-chat-expanded").style.display = "none";
        document.getElementById("ai-chat-minimized").style.display = "flex";
      }
      function closeChat() {
        document.getElementById("ai-chat-expanded").style.display = "none";
        document.getElementById("ai-chat-minimized").style.display = "flex";
      }
      function sendMessage(event) {
        event.preventDefault();
        const input = document.getElementById("ai-chat-input");
        const messagesContainer = document.getElementById("ai-chat-messages");
        const userMsg = input.value.trim();

        if (!userMsg) return; // Don't send empty messages

        messagesContainer.innerHTML += `<div><b>You:</b> ${userMsg}</div>`;
        input.value = "";
        // Show loading message
        const loadingId = `loading-${Date.now()}`;
        messagesContainer.innerHTML += `<div id="${loadingId}"><b>AI:</b> <i>Thinking...</i></div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ userMsg: userMsg }),
        })
          .then((response) => {
            if (!response.ok) {
              // Throw an error to be caught by the .catch block
              throw new Error(
                `Network response was not ok, status: ${response.status}`
              );
            }
            return response.json();
          })
          .then((data) => {
            // Replace loading message with actual AI response
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
              loadingElement.innerHTML = `<b>AI:</b> ${data.message}`;
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
          })
          .catch((error) => {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
              loadingElement.innerHTML = `<b>AI:</b> <i>Sorry, an error occurred. Please try again.</i>`;
              console.error("Error during fetch:", error);
            }
          });
      }
      function toggleProfileDropdown() {
        const dropdown = document.getElementById("profile-dropdown");
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      }
      window.onclick = function (event) {
        if (!event.target.matches(".nav-profile-img")) {
          var dropdown = document.getElementById("profile-dropdown");
          if (dropdown && dropdown.style.display === "block") {
            dropdown.style.display = "none";
          }
        }
      };
    </script>
    <script>
      const wrapper = document.getElementById("profileDropdownWrapper");
      const dropdown = document.getElementById("profileDropdown");
      let hideTimeout;

      function showDropdown() {
        dropdown.style.display = "block";
        clearTimeout(hideTimeout);
      }

      function hideDropdown() {
        hideTimeout = setTimeout(() => {
          dropdown.style.display = "none";
        }, 500);
      }

      wrapper.addEventListener("mouseenter", showDropdown);
      wrapper.addEventListener("mouseleave", hideDropdown);

      dropdown.addEventListener("mouseenter", showDropdown);
      dropdown.addEventListener("mouseleave", hideDropdown);
    </script>
  </body>
</html>
