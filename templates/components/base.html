<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Marvel Rival Website{% endblock %}</title>
    <link
      href="https://fonts.googleapis.com/css?family=Oswald:700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:400,600&display=swap"
      rel="stylesheet"
    />
    <!-- Linking CSS file for base layout -->
    <link
      href="{{ url_for('static', filename='css/components/base.css') }}"
      rel="stylesheet"
    />
    {% block head %}{% endblock %}
  </head>
  <body>
    <nav class="main-nav-bar">
      <div class="nav-outer-flex">
        <div class="nav-side"></div>
        <div class="nav-links">
          <a href="{{ url_for('home.home') }}">Home</a>
          <a href="{{ url_for('heroes.heroes') }}">All Heroes</a>
          <a href="{{ url_for('favorite.favorite') }}">Favorites</a>
          <a href="{{ url_for('compare.compare_select') }}">Compare</a>
        </div>
        <div class="nav-profile-container">
          <div class="profile-dropdown-wrapper" id="profileDropdownWrapper">
            <img
              src="{{ url_for('static', filename=profile_image_url) }}"
              alt="Profile"
              class="nav-profile-img"
              tabindex="0"
              onclick="toggleProfileDropdown()"
            />
            <div id="profileDropdown" class="profile-dropdown">
              <a href="{{ url_for('user.user_page') }}">User Page</a>
              <a href="{{ url_for('login.login') }}">Login</a>
              <a href="{{ url_for('signup.signup') }}">Sign Up</a>
              <a href="{{ url_for('login.logout') }}">Logout</a>
            </div>
          </div>
        </div>
      </div>
    </nav>
    {% block content %}{% endblock %}

    <!-- AI Chat Widget -->
    <div id="ai-chat-widget">
      <div
        id="ai-chat-minimized"
        onclick="expandChat()"
        tabindex="0"
        aria-label="Open AI Chat"
        style="cursor: pointer"
      >
        <span>ðŸ’¬</span>
      </div>
      <div id="ai-chat-expanded" style="display: none; flex-direction: column">
        <div
          id="ai-chat-header"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <span>AI Chat <span id="ai-chat-usage"></span></span>
          <div>
            <!-- Only keep the close (Ã—) button -->
            <button type="button" onclick="closeChat()" aria-label="Close chat">
              Ã—
            </button>
          </div>
        </div>
        <div
          id="ai-chat-messages"
          style="
            flex: 1 1 auto;
            overflow-y: auto;
            max-height: 250px;
            margin-bottom: 8px;
            padding: 8px;
          "
        ></div>
        <form
          id="ai-chat-form"
          onsubmit="sendMessage(event)"
          autocomplete="off"
          style="display: flex"
        >
          <div class="ai-chat-input-wrapper">
            <input
              type="text"
              id="ai-chat-input"
              placeholder="Ask me anything..."
              maxlength="100"
              required
              style="
                flex: 1 1 auto;
                padding: 6px;
                border-radius: 4px;
                border: 1px solid #bfa046;
              "
              aria-label="Type your message to the AI"
              oninput="updateAiCharCount()"
            />
            <span id="ai-chat-char-count" class="ai-chat-char-count"
              >0/100</span
            >
          </div>
          <button type="submit" style="margin-left: 6px">Send</button>
        </form>
      </div>
    </div>
    <script>
      // Expands the AI chat window when the minimized icon is clicked,
      // so users can start or continue a conversation without losing chat history
      function expandChat() {
        document.getElementById("ai-chat-minimized").style.display = "none";
        document.getElementById("ai-chat-expanded").style.display = "flex";
        loadChatHistory();
        document.getElementById("ai-chat-input").focus();
        // Scrolls to the latest message for better user experience
        const messagesContainer = document.getElementById("ai-chat-messages");
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        updateAiUsage();
      }

      // Minimizes the AI chat window, keeping the chat history intact,
      // so users can quickly hide the chat without losing their conversation
      function minimizeChat() {
        document.getElementById("ai-chat-expanded").style.display = "none";
        document.getElementById("ai-chat-minimized").style.display = "flex";
        saveChatHistory();
      }

      // Closes the AI chat window and preserves chat history,
      // allowing users to reopen the chat and continue where they left off
      function closeChat() {
        document.getElementById("ai-chat-expanded").style.display = "none";
        document.getElementById("ai-chat-minimized").style.display = "flex";
        saveChatHistory();
      }

      // Updates the character count display as the user types,
      // providing immediate feedback to help users stay within the limit
      function updateAiCharCount() {
        const input = document.getElementById("ai-chat-input");
        const count = input.value.length;
        document.getElementById("ai-chat-char-count").textContent =
          count + "/100";
      }

      // Sends the user's message to the backend and displays the AI's response,
      // so users can interact with the AI and see their conversation in real time
      function sendMessage(event) {
        event.preventDefault();
        const input = document.getElementById("ai-chat-input");
        const messagesContainer = document.getElementById("ai-chat-messages");
        const userMsg = input.value.trim();

        if (!userMsg) return;

        // Shows the user's message in the chat window for context
        messagesContainer.innerHTML += `<div><b>You:</b> ${userMsg}</div>`;
        input.value = "";
        updateAiCharCount();
        input.disabled = true;

        // Shows a loading indicator while waiting for the AI's response
        const loadingId = `loading-${Date.now()}`;
        messagesContainer.innerHTML += `<div id="${loadingId}"><b>AI:</b> <i>Thinking...</i></div>`;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        saveChatHistory();

        fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userMsg: userMsg }),
        })
          .then((response) => response.json())
          .then((data) => {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
              loadingElement.innerHTML = `<b>AI:</b> ${
                data.message ||
                "<i>Sorry, an error occurred. Please try again.</i>"
              }`;
            }
            // Updates the usage counter to inform users about their remaining quota
            if (data.ratelimit_remaining && data.ratelimit_limit) {
              document.getElementById(
                "ai-chat-usage"
              ).textContent = `(Usage left: ${data.ratelimit_remaining}/${data.ratelimit_limit})`;
            } else {
              document.getElementById("ai-chat-usage").textContent = "";
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            saveChatHistory();
          })
          .catch((error) => {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
              loadingElement.innerHTML = `<b>AI:</b> <i>Sorry, an error occurred. Please try again.</i>`;
            }
            console.error("Error during fetch:", error);
            saveChatHistory();
          })
          .finally(() => {
            input.disabled = false;
            input.focus();
          });
      }

      // Loads chat history from localStorage so users can continue their conversation
      function loadChatHistory() {
        const saved = localStorage.getItem("aiChatHistory");
        if (saved) {
          document.getElementById("ai-chat-messages").innerHTML = saved;
        }
      }

      // Saves chat history to localStorage to persist conversations across page reloads
      function saveChatHistory() {
        localStorage.setItem(
          "aiChatHistory",
          document.getElementById("ai-chat-messages").innerHTML
        );
      }

      // Updates the usage counter by fetching from the backend,
      // so users are aware of their remaining API quota
      function updateAiUsage() {
        fetch("/chat_usage")
          .then((res) => res.json())
          .then((data) => {
            document.getElementById(
              "ai-chat-usage"
            ).textContent = `(Usage: ${data.count}/${data.limit})`;
          });
      }

      // Allows keyboard users to open the chat with Enter or Space for accessibility
      document
        .getElementById("ai-chat-minimized")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter" || e.key === " ") expandChat();
        });

      // Loads chat history on page load if chat is already open,
      // so users don't lose their conversation when navigating the site
      window.addEventListener("DOMContentLoaded", function () {
        loadChatHistory();
      });
    </script>
    <script>
      function toggleProfileDropdown() {
        const dropdown = document.getElementById("profile-dropdown");
        dropdown.style.display =
          dropdown.style.display === "block" ? "none" : "block";
      }
      window.onclick = function (event) {
        if (!event.target.matches(".nav-profile-img")) {
          var dropdown = document.getElementById("profile-dropdown");
          if (dropdown && dropdown.style.display === "block") {
            dropdown.style.display = "none";
          }
        }
      };
    </script>
    <script>
      const wrapper = document.getElementById("profileDropdownWrapper");
      const dropdown = document.getElementById("profileDropdown");
      let hideTimeout;

      function showDropdown() {
        dropdown.style.display = "block";
        clearTimeout(hideTimeout);
      }

      function hideDropdown() {
        hideTimeout = setTimeout(() => {
          dropdown.style.display = "none";
        }, 500);
      }

      wrapper.addEventListener("mouseenter", showDropdown);
      wrapper.addEventListener("mouseleave", hideDropdown);

      dropdown.addEventListener("mouseenter", showDropdown);
      dropdown.addEventListener("mouseleave", hideDropdown);
    </script>
  </body>
</html>
